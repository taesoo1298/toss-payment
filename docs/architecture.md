# ğŸ—ï¸ Toss Payments Laravel ëª¨ë“ˆ ì•„í‚¤í…ì²˜

## ğŸ“ ì „ì²´ ì•„í‚¤í…ì²˜ ê°œìš”

ì´ ëª¨ë“ˆì€ Laravelì˜ ìµœì‹  best practiceì™€ ë””ìì¸ íŒ¨í„´ì„ ì ìš©í•˜ì—¬ êµ¬í˜„ë˜ì—ˆìŠµë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Frontend Layer                         â”‚
â”‚  (React, Vue, Vanilla JS + Toss Payments SDK)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ HTTP/HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Laravel API Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Controllers                            â”‚   â”‚
â”‚  â”‚  - TossPaymentController                            â”‚   â”‚
â”‚  â”‚  - TossWebhookController                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Form Requests (Validation)                â”‚   â”‚
â”‚  â”‚  - PaymentPrepareRequest                            â”‚   â”‚
â”‚  â”‚  - PaymentConfirmRequest                            â”‚   â”‚
â”‚  â”‚  - PaymentCancelRequest                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Service Layer                          â”‚   â”‚
â”‚  â”‚  - TossPaymentService (Business Logic)              â”‚   â”‚
â”‚  â”‚  - TossApiClient (External API)                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Repository Layer                          â”‚   â”‚
â”‚  â”‚  - PaymentRepository (Data Access)                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Model Layer                            â”‚   â”‚
â”‚  â”‚  - Payment (Eloquent Model)                         â”‚   â”‚
â”‚  â”‚  - PaymentTransaction                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Event & Listener                          â”‚   â”‚
â”‚  â”‚  Events:                                            â”‚   â”‚
â”‚  â”‚  - PaymentCompleted                                 â”‚   â”‚
â”‚  â”‚  - PaymentFailed                                    â”‚   â”‚
â”‚  â”‚  - PaymentCancelled                                 â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚  Listeners:                                         â”‚   â”‚
â”‚  â”‚  - SendPaymentConfirmationEmail                     â”‚   â”‚
â”‚  â”‚  - UpdateOrderStatus                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Queue Jobs                             â”‚   â”‚
â”‚  â”‚  - ProcessTossWebhook                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Database Layer                            â”‚
â”‚  - payments table                                            â”‚
â”‚  - payment_transactions table                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               External Services                              â”‚
â”‚  - Toss Payments API                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ ê²°ì œ í”Œë¡œìš°

### 1. ì¼ë°˜ ê²°ì œ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     1. Prepare     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚          â”‚
â”‚  Client â”‚                     â”‚  Laravel â”‚
â”‚         â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   API    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   2. Order Info     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                â”‚
     â”‚ 3. Open Payment Window         â”‚ 4. Save to DB
     â”‚    (Toss Payments SDK)         â”‚    (status: ready)
     â–¼                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚  Toss   â”‚                           â”‚
â”‚Payments â”‚                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
     â”‚                                â”‚
     â”‚ 5. User Authentication         â”‚
     â”‚    & Payment                   â”‚
     â”‚                                â”‚
     â”‚ 6. Success Redirect            â”‚
     â–¼                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     7. Confirm      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚          â”‚
â”‚  Client â”‚                     â”‚  Laravel â”‚
â”‚         â”‚                     â”‚   API    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ 8. Call Toss API
                                     â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚  Toss   â”‚
                                â”‚   API   â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ 9. Approval Response
                                     â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚  Update  â”‚
                                â”‚    DB    â”‚
                                â”‚ (status: â”‚
                                â”‚  done)   â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ 10. Dispatch Events
                                     â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚ Listenersâ”‚
                                â”‚  - Email â”‚
                                â”‚  - Order â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ì›¹í›… ì²˜ë¦¬ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     1. Webhook       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Toss   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚  Laravel â”‚
â”‚   API   â”‚                      â”‚  Webhook â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚ Endpoint â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ 2. Verify Signature
                                      â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚Middlewareâ”‚
                                 â”‚  Verify  â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ 3. Dispatch to Queue
                                      â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚  Queue   â”‚
                                 â”‚   Job    â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ 4. Process Async
                                      â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚  Update  â”‚
                                 â”‚    DB    â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ 5. Dispatch Events
                                      â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚ Listenersâ”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¨ ë””ìì¸ íŒ¨í„´

### 1. Service Layer Pattern

**ëª©ì :** ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë¶„ë¦¬

```php
// âŒ Bad: Controllerì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
class TossPaymentController
{
    public function confirm(Request $request)
    {
        $payment = Payment::where('order_id', $request->order_id)->first();
        // ... ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ...
    }
}

// âœ… Good: Service Layer ì‚¬ìš©
class TossPaymentController
{
    public function __construct(
        private TossPaymentService $paymentService
    ) {}

    public function confirm(PaymentConfirmRequest $request)
    {
        $payment = $this->paymentService->confirm($request->validated());
        return new PaymentResource($payment);
    }
}
```

### 2. Repository Pattern

**ëª©ì :** ë°ì´í„° ì ‘ê·¼ ë¡œì§ ì¶”ìƒí™”

```php
// Service Layerì—ì„œ Repository ì‚¬ìš©
class TossPaymentService
{
    public function __construct(
        private PaymentRepository $paymentRepository
    ) {}

    public function confirm(array $data): Payment
    {
        $payment = $this->paymentRepository->findByOrderId($data['order_id']);
        // ...
    }
}
```

### 3. Event-Driven Architecture

**ëª©ì :** ê²°ì œ ì™„ë£Œ í›„ ì—¬ëŸ¬ ì‘ì—…ì„ ë¶„ë¦¬í•˜ì—¬ ì²˜ë¦¬

```php
// ê²°ì œ ìŠ¹ì¸ í›„ ì´ë²¤íŠ¸ ë°œí–‰
event(new PaymentCompleted($payment));

// ì—¬ëŸ¬ Listenerê°€ ë…ë¦½ì ìœ¼ë¡œ ì²˜ë¦¬
- SendPaymentConfirmationEmail
- UpdateOrderStatus
- SendSlackNotification
```

### 4. Strategy Pattern (Enum í™œìš©)

**ëª©ì :** ê²°ì œ ìƒíƒœì™€ ë©”ì„œë“œë¥¼ íƒ€ì… ì•ˆì „í•˜ê²Œ ê´€ë¦¬

```php
enum PaymentStatus: string
{
    case DONE = 'done';
    case CANCELED = 'canceled';

    public function isCompleted(): bool
    {
        return $this === self::DONE;
    }
}

// ì‚¬ìš©
if ($payment->status->isCompleted()) {
    // ...
}
```

## ğŸ” ë³´ì•ˆ ì„¤ê³„

### 1. ê³„ì¸µë³„ ë³´ì•ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Network Layer                           â”‚
â”‚  - HTTPS                                 â”‚
â”‚  - Rate Limiting                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application Layer                       â”‚
â”‚  - Authentication (Sanctum)              â”‚
â”‚  - Authorization                         â”‚
â”‚  - CSRF Protection                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Business Logic Layer                    â”‚
â”‚  - Input Validation (Form Request)       â”‚
â”‚  - Amount Verification                   â”‚
â”‚  - Status Check                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Layer                              â”‚
â”‚  - SQL Injection Prevention (Eloquent)   â”‚
â”‚  - Encrypted Sensitive Data              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ì›¹í›… ë³´ì•ˆ

```php
// 1. Signature ê²€ì¦
class VerifyTossWebhookSignature
{
    public function handle(Request $request, Closure $next)
    {
        $signature = $request->header('X-Toss-Signature');
        $payload = $request->getContent();
        $expectedSignature = hash_hmac('sha256', $payload, $secret);

        if (!hash_equals($expectedSignature, $signature)) {
            return response()->json(['error' => 'Invalid signature'], 401);
        }

        return $next($request);
    }
}

// 2. Idempotency (ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€)
if ($payment->isCompleted()) {
    return $payment; // ì´ë¯¸ ì²˜ë¦¬ë¨
}
```

## ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

### ERD (Entity Relationship Diagram)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        users            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                 â”‚
â”‚ name                    â”‚
â”‚ email                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ 1:N
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      payments           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                 â”‚
â”‚ user_id (FK)            â”‚
â”‚ order_id (UQ)           â”‚
â”‚ payment_key (UQ)        â”‚
â”‚ status                  â”‚
â”‚ total_amount            â”‚
â”‚ balance_amount          â”‚
â”‚ ...                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ 1:N
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ payment_transactions    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                 â”‚
â”‚ payment_id (FK)         â”‚
â”‚ transaction_key         â”‚
â”‚ type                    â”‚
â”‚ amount                  â”‚
â”‚ raw_data (JSON)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì¸ë±ìŠ¤ ì „ëµ

```sql
-- ìì£¼ ì¡°íšŒë˜ëŠ” ì»¬ëŸ¼
INDEX idx_order_id ON payments(order_id);
INDEX idx_payment_key ON payments(payment_key);
INDEX idx_user_status ON payments(user_id, status);
INDEX idx_approved_at ON payments(approved_at);

-- ë³µí•© ì¸ë±ìŠ¤
INDEX idx_created_status ON payments(created_at, status);
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì „ëµ

### 1. í…ŒìŠ¤íŠ¸ í”¼ë¼ë¯¸ë“œ

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  E2E   â”‚  â† ì ìŒ (ëŠë¦¼)
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚Feature â”‚  â† ì¤‘ê°„
        â”‚  Test  â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  Unit  â”‚  â† ë§ìŒ (ë¹ ë¦„)
        â”‚  Test  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€

-   **Controllers:** Feature Test
-   **Services:** Unit Test
-   **Repositories:** Unit Test
-   **Models:** Unit Test
-   **Events/Listeners:** Feature Test

```bash
# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
php artisan test

# ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸
php artisan test --coverage
```

## ğŸš€ ì„±ëŠ¥ ìµœì í™”

### 1. N+1 ì¿¼ë¦¬ ë°©ì§€

```php
// âŒ Bad: N+1 ì¿¼ë¦¬
$payments = Payment::all();
foreach ($payments as $payment) {
    echo $payment->user->name; // Në²ˆì˜ ì¶”ê°€ ì¿¼ë¦¬
}

// âœ… Good: Eager Loading
$payments = Payment::with('user')->all();
foreach ($payments as $payment) {
    echo $payment->user->name; // 1ë²ˆì˜ ì¿¼ë¦¬
}
```

### 2. ìºì‹± ì „ëµ

```php
// Payment í†µê³„ ìºì‹±
Cache::remember('payment_stats_' . $userId, 3600, function () use ($userId) {
    return $this->paymentRepository->getStatistics([
        'user_id' => $userId,
    ]);
});
```

### 3. Queue í™œìš©

```php
// ì›¹í›… ì²˜ë¦¬ë¥¼ ë¹„ë™ê¸°ë¡œ
ProcessTossWebhook::dispatch($payload);

// ì´ë©”ì¼ ë°œì†¡ì„ ë¹„ë™ê¸°ë¡œ
class SendPaymentConfirmationEmail implements ShouldQueue
{
    // ...
}
```

## ğŸ“ˆ ëª¨ë‹ˆí„°ë§ & ë¡œê¹…

### 1. ë¡œê·¸ ë ˆë²¨

```php
// ERROR: ê²°ì œ ì‹¤íŒ¨, API ì˜¤ë¥˜
Log::error('Payment confirmation failed', [
    'order_id' => $orderId,
    'error' => $e->getMessage(),
]);

// WARNING: ë¹„ì •ìƒ ìƒíƒœ
Log::warning('Duplicate payment attempt', [
    'payment_key' => $paymentKey,
]);

// INFO: ì •ìƒ íë¦„
Log::info('Payment completed', [
    'order_id' => $payment->order_id,
    'amount' => $payment->total_amount,
]);
```

### 2. ë©”íŠ¸ë¦­ ìˆ˜ì§‘

```php
// ê²°ì œ ì„±ê³µë¥ 
$successRate = Payment::completed()->count() / Payment::count() * 100;

// í‰ê·  ê²°ì œ ê¸ˆì•¡
$avgAmount = Payment::completed()->avg('total_amount');

// ì·¨ì†Œìœ¨
$cancelRate = Payment::where('status', 'canceled')->count() / Payment::count() * 100;
```

## ğŸ”„ ë°°í¬ ì „ëµ

### 1. Zero-Downtime Deployment

```bash
# 1. ìƒˆ ë²„ì „ ë°°í¬
git pull
composer install --no-dev
php artisan migrate --force

# 2. Queue worker ì¬ì‹œì‘
php artisan queue:restart

# 3. ìºì‹œ í´ë¦¬ì–´
php artisan optimize:clear
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

### 2. Blue-Green Deployment

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Blue   â”‚     â”‚  Green  â”‚
â”‚ (Old)   â”‚     â”‚  (New)  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
        â”‚Load     â”‚
        â”‚Balancer â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Best Practices ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì½”ë“œ í’ˆì§ˆ

-   [x] PSR í‘œì¤€ ì¤€ìˆ˜
-   [x] Type Hinting ì‚¬ìš©
-   [x] Enum í™œìš©
-   [x] ì˜ì¡´ì„± ì£¼ì…
-   [x] ë‹¨ì¼ ì±…ì„ ì›ì¹™

### ë³´ì•ˆ

-   [x] Input Validation
-   [x] SQL Injection ë°©ì§€
-   [x] CSRF ë³´í˜¸
-   [x] XSS ë°©ì§€
-   [x] ì›¹í›… ì„œëª… ê²€ì¦

### ì„±ëŠ¥

-   [x] Eager Loading
-   [x] ìºì‹±
-   [x] Queue í™œìš©
-   [x] ì¸ë±ìŠ¤ ìµœì í™”
-   [x] Connection Pooling

### í…ŒìŠ¤íŠ¸

-   [x] Feature Test
-   [x] HTTP Mock
-   [x] Database Transaction
-   [x] Factory ì‚¬ìš©

### ë¬¸ì„œí™”

-   [x] README
-   [x] API ë¬¸ì„œ
-   [x] ì„¤ì¹˜ ê°€ì´ë“œ
-   [x] ì•„í‚¤í…ì²˜ ë¬¸ì„œ

## ğŸ“š ì°¸ê³  ìë£Œ

-   [Laravel Documentation](https://laravel.com/docs)
-   [Toss Payments API](https://docs.tosspayments.com/)
-   [Laravel Best Practices](https://github.com/alexeymezenin/laravel-best-practices)
-   [PHP The Right Way](https://phptherightway.com/)
-   [PSR Standards](https://www.php-fig.org/psr/)

---

**ì‘ì„±ì¼:** 2025ë…„ 10ì›”
**ë²„ì „:** 1.0.0
**Laravel ë²„ì „:** 11.x / 12.x
